{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-6 offset-md-3">
        <h2>Upload YouTube Audio</h2>
        <form id="uploadForm" class="mt-4">
            <div class="mb-3">
                <label for="name" class="form-label">Name</label>
                <input type="text" class="form-control" id="name" name="name" required>
            </div>
            <div class="mb-3">
                <label for="url" class="form-label">YouTube URL</label>
                <input type="url" class="form-control" id="url" name="url" required>
            </div>
            <button type="submit" class="btn btn-primary">Download</button>
        </form>

        <div id="downloadStatus" class="mt-4">
            <h3>Download Queue</h3>
            <div id="queueItems"></div>
        </div>
    </div>
</div>

<script>
const activeDownloads = new Map();

function updateDownloadStatus(taskId, name) {
    const checkStatus = async () => {
        try {
            const response = await fetch(`/download-status/${taskId}`);
            const data = await response.json();
            
            const statusDiv = document.getElementById(`status-${taskId}`);
            if (!statusDiv) return;
            
            if (data.status === 'completed') {
                statusDiv.innerHTML = `✅ ${name} - Complete`;
                activeDownloads.delete(taskId);
            } else if (data.status === 'failed') {
                statusDiv.innerHTML = `❌ ${name} - Failed: ${data.error}`;
                activeDownloads.delete(taskId);
            } else if (data.status === 'downloading') {
                statusDiv.innerHTML = `⏳ ${name} - Downloading...`;
                if (activeDownloads.has(taskId)) {
                    setTimeout(() => checkStatus(), 1000);
                }
            }
        } catch (error) {
            console.error('Status check error:', error);
        }
    };
    
    return checkStatus();
}

document.getElementById('uploadForm').onsubmit = async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const name = formData.get('name');
    
    try {
        const response = await fetch('/download', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        if (data.status === 'queued') {
            const queueItems = document.getElementById('queueItems');
            const statusDiv = document.createElement('div');
            statusDiv.id = `status-${data.task_id}`;
            statusDiv.innerHTML = `⏳ ${name} - Queued...`;
            queueItems.appendChild(statusDiv);
            
            activeDownloads.set(data.task_id, true);
            updateDownloadStatus(data.task_id, name);
            
            e.target.reset();
        } else {
            alert('Error queuing download');
        }
    } catch (error) {
        alert('Error starting download');
    }
};
</script>
{% endblock %} 